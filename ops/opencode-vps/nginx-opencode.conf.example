server {
  # Public port
  listen 4096;
  server_name _;

  # Allow larger file uploads (attachments)
  client_max_body_size 50m;

  # Browser auth (protect the public endpoint)
  auth_basic "OpenCode";
  auth_basic_user_file /etc/nginx/opencode.htpasswd;

  # Upstream auth injection:
  # Base64(user:pass), e.g.:
  #   printf '%s' "opencode:YOUR_PASSWORD" | base64
  # IMPORTANT: do not commit secrets in this file.
  set $opencode_upstream_auth "Basic BASE64_USER_COLON_PASS";

  # Patched main bundle (entry module)
  # The hash changes when OpenCode updates. Keep this in sync with HTML.
  location = /assets/index-REPLACE_WITH_HASH.js {
    alias /srv/opencode/overrides/assets/index-REPLACE_WITH_HASH.js;
    default_type application/javascript;
    add_header Cache-Control "no-store" always;
  }

  # Session chunk: proxy (no-store) to avoid cached/broken chunks in browsers
  # Prefer proxying chunks from upstream rather than overriding them.
  location = /assets/session-REPLACE_WITH_HASH.js {
    proxy_pass http://127.0.0.1:4097;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $opencode_upstream_auth;

    add_header Cache-Control "no-store" always;
  }

  # SSE endpoints must be unbuffered
  location = /global/event {
    proxy_pass http://127.0.0.1:4097;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $opencode_upstream_auth;

    proxy_buffering off;
    proxy_read_timeout 3600s;
  }

  location = /event {
    proxy_pass http://127.0.0.1:4097;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $opencode_upstream_auth;

    proxy_buffering off;
    proxy_read_timeout 3600s;
  }

  # Default: proxy the app
  location / {
    proxy_pass http://127.0.0.1:4097;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $opencode_upstream_auth;

    # Keep CSP compatible with Safari and allow changelog fetch.
    proxy_hide_header Content-Security-Policy;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; media-src 'self' data:; connect-src 'self' data: https://opencode.ai; manifest-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'" always;

    proxy_read_timeout 3600s;
  }
}

